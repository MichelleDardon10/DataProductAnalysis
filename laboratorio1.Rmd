---
title: "Stores Analysis"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---


```{r setup, include=FALSE}
library(maps)
library(flexdashboard)
library(readr)
library(dplyr)
library(leaflet)
library(crosstalk)
library(DT)
library(mapdata)
library(ggplot2)
library(plotly)
library(viridis)

data <- read_csv("tienda (1).csv")

```
<!--
1. Utilidad: segmentar segun Product_ID, Product_Name con Sales y Profit y grafico
2. Segmentacion: Segment, Sales y Profit. Solo grafica
3. Geografia: Country, region, state, city con profit -> MAPA
4. Analisis de entregas: eficiencia en tiempos y en geografía
   Order_ID, Order_Date, Ship_Date, TIME, Ship_Mode, State, City y region -> graficar sin latitud y longitud
   libreria posible lubridate
   
   Una pagina por dashboard
   
Requisitos
El dashboard debe de contener
Graficas
Tablas
Mapas
En por lo menos un caso utilizar la librería crosstalk

TABS - 3

TASKS:
1. Gráfico y tabla con productos más vendidos -> DANIEL
2. Gráfico de barras (una sales y otra profit) por segmento -> DANIEL


-->



```{r}

data$ProductName <- (data$`Product Name`)

data <- data %>%
  filter(!is.na(data$`Profit;`))

data$Profit <- as.numeric(gsub("[^0-9.-]", "", data$`Profit;`))


```
# Profit {data-icon=fa-money}

### Profit per product {data-width=600}

```{r}

profit_by_state <- data %>%
  group_by(data$State, data$ProductName) %>%
  summarise(Total.Profit = sum(data$Profit, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(Total.Profit)) %>%
  slice(1)

head(profit_by_state)

```

# Delivery {data-icon=fa-truck}

### Delivery Efficiency {data-width=350}

```{r}
data$Order_Date <- data$`Order Date`
data$Ship_Date <- data$`Ship Date`

data$Order_Date <- as.Date(data$Order_Date, format="%m/%d/%Y")
data$Ship_Date <- as.Date(data$Ship_Date, format="%m/%d/%Y")


data$Time_Difference <- as.numeric(data$Ship_Date - data$Order_Date)

data <- data[!is.na(data$Time_Difference), ]

efficiency_by_state <- data %>%
  group_by(State) %>%
  arrange(desc(Time_Difference)) %>%
  slice(1) %>%
  select(State, Time_Difference) %>%
  arrange(desc(Time_Difference))

# Display the result
datatable(efficiency_by_state)
```

### Delivery per State {data-width=800}

```{r}
data$Order_Date <- data$`Order Date`
data$Ship_Date <- data$`Ship Date`

data$Order_Date <- as.Date(data$Order_Date, format="%m/%d/%Y")
data$Ship_Date <- as.Date(data$Ship_Date, format="%m/%d/%Y")


data$Time_Difference <- as.numeric(data$Ship_Date - data$Order_Date)

data <- data[!is.na(data$Time_Difference), ]

efficiency_by_state <- data %>%
  group_by(State) %>%
  arrange(desc(Time_Difference)) %>%
  slice(1) %>%
  select(State, Time_Difference) %>%
  arrange(desc(Time_Difference))

# Load US state map data
state_map <- map_data("state")

# Convert state names to lowercase to match the `state_map` format
efficiency_by_state <- efficiency_by_state %>%
  mutate(State = tolower(State))

# Merge with map data
merged_data <- left_join(state_map, efficiency_by_state, by = c("region" = "State"))

gg_map <- ggplot(data = merged_data) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = Time_Difference, 
                   text = paste("State:", region, "<br>Time Difference:", Time_Difference)), 
               color = "black") +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(title = "Shipping Efficiency by State", fill = "Days") +
  theme(legend.position = "bottom")

# Convert ggplot to an interactive plotly object
interactive_map <- ggplotly(gg_map, tooltip = "text")

# Display the interactive map
interactive_map

```

# Mapa {data-icon=fa-globe}
### Profit por Estado

```{r}

#MINUSCULAS 
profit_by_state <- data %>%
  mutate(State = tolower(State))


# CARGAR MAPA Y RENOMBRAR
state_map2 <- map_data("state")
state_map2 <- state_map2 %>%
  rename(State = region)

# NUEVA DATA 
state_coords <- state_map2 %>%
  group_by(State, group) %>%
  summarise(lat = mean(lat), long = mean(long))

profit_with_coords <- left_join(profit_by_state, state_coords, by = "State")

profit_with_coords <- profit_with_coords %>%
  group_by(State, lat, long, group) %>%
  summarise(Total_Profit = sum(Profit, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(Total_Profit))

#### SOLO TIRA PUNTOS
# Crear un mapa básico nuevamente con coloración
gg_map <- ggplot(data = profit_with_coords_clean) +
  geom_point(aes(x = long, y = lat, color = Total_Profit), size = 3) +
  scale_color_viridis_c() +
  theme_minimal() +
  labs(title = "Total Profit by State", color = "Profit")

# Mostrar el mapa de puntos
print(gg_map)


####NO FUNCIONA

# CREAR MAPA
gg_map2 <- ggplot(data = state_map2) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = Total_Profit, 
                   text = paste("State:", State, "<br>Total Profit:", Total_Profit)), 
               color = "black", data = profit_with_coords) +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(title = "Total Profit by State", fill = "Profit") +
  theme(legend.position = "bottom")

# Convertir ggplot a un objeto interactivo plotly
interactive_map2 <- ggplotly(gg_map2, tooltip = "text")

# Mostrar el mapa interactivo
interactive_map2

```


